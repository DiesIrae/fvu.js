<!DOCTYPE html>
<meta charset="utf-8">

<style>
  .table {
    width: 500px;
    border: 0px;
  }
  .input-select { width: 100%; }
  .values {
    font-size: 10px; 
    font-family: Helvetica, sans-serif;
    fill: black;
  }
  .chart {
    width: 500px;
    height: 300px;
    border: 1px solid black;
  }
  .axis text {
  font: 12px sans-serif;
  }
  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    background-sizehape-rendering: crispEdges;
  }
</style>

<h1>Damage Family Comparison</h1>

<div>
<table class="table">
  <tr>
    <td colspan="2" bgcolor="darkred" style="color:white">SAMPLE 1</td>
    <td colspan="2" bgcolor="darkblue" style="color:white">SAMPLE 2</td>
  </tr>
  <tr>
    <td>Brand: </td>
    <td>
      <select id="tb1" name="truckBrand" size=1 class="input-select"></select>
    </td>
    <td>Brand: </td>
    <td>
      <select id="tb2" name="truckBrand" size=1 class="input-select"></select>
    </td>
  </tr>
  <tr>
    <td width="100px">Exam Year: </td>
    <td>
      <select id="ey1" name="examYear" size=1 class="input-select"></select>
    </td>
      <td width="100px">Exam Year: </td>
    <td>
      <select id="ey2" name="examYear" size=1 class="input-select"></select>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <button onclick="makeTransition();" style="width:100%;background-color:darkred;color:white">Switch!</button>
    </td>
    <td colspan="2">
      <button onclick="makeTransition();" style="width:100%;background-color:darkblue;color:white">Switch!</button>
    </td>
  </tr>
</table>
</div>


<div>
  <svg class="chart"></svg>
</div>

<h3>TOP20 Damage Codes:</h3>

<script type="text/javascript" src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script> 
<script type="text/javascript">

// Global Objects
var socket = io();
var chart = document.getElementsByClassName("chart")[0];
var DFAMS = ['ACCI', 'AGRE', 'AGZB', 'ENCF', 'ENST', 
            'ENZB', 'INFI', 'RECH', 'REST', 'RPLA', 
            'USUR'];
var COLORS = ['darkred', 'darkblue'];

// For Debugging
var rects;
var text;
var xlabels;
var datag;

// Parameters
var margin = {top: 20, right: 30, bottom: 30, left: 40}
var width = chart.getClientRects()[0].width - margin.left - margin.right;
var height = chart.getClientRects()[0].height -margin.top - margin.bottom;

// Scale
var y_max = 0.5;
// var x = d3.scale.linear().domain([0, nBars]).range([0, width]);
var x = d3.scale.ordinal().domain(DFAMS).rangeRoundBands([0, width], 0.1, 0.1);
// var x = d3.scale.ordinal().domain(DFAMS).rangePoints([0, width],2);
var y = d3.scale.linear().domain([y_max, 0])
  .rangeRound([0, height]);

var nBars = DFAMS.length;
var barWidth = Math.floor(x.rangeBand() / COLORS.length);
var barDx = d3.scale.ordinal().domain(COLORS).rangeRoundBands([0, x.rangeBand()]);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

// add the canvas to the DOM
var svg = d3.select(".chart").append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// add the yAxis
svg.append("g")
    .attr("class", "y axis");

svg.append("g")
    .attr("class", "x axis");

svg.selectAll(".y.axis")
    .call(yAxis);
svg.selectAll(".x.axis")
    .attr("transform", "translate(0," + y(0) + ")")
    .call(xAxis);

// require unique values to put into the filters
var uniqueColumns = ['brand','exam_year'];
socket.emit('getUnique', uniqueColumns);

//-------------------------------------------------------
// When receiving new data
//-------------------------------------------------------

socket.on('uniqueDict', function(uniqueDict){
  //update the filters
  fillFilters(uniqueDict);
});

socket.on('updateDfamGraph', function(msgs){
  //update the graphs
  updateGraph(msgs);
});

socket.on('updateDmCodeGraph', function(data){
  //update the graphs
  updateDmCodeGraph(data);
});

//-------------------------------------------------------
// makeTransition function
//-------------------------------------------------------

function makeTransition() {

  var params = [];

  COLORS.forEach(function(color, i){
    var eyList = document.getElementById("ey"+(i+1));
    var tbList = document.getElementById("tb"+(i+1));
    params.push({
      brand : tbList.options[tbList.selectedIndex].text,
      year : eyList.options[eyList.selectedIndex].text,
      color : color
    });    
  })
  socket.emit('extractDfamData', params);
  socket.emit('extractDmCodeData', params);

}
//-------------------------------------------------------

//-------------------------------------------------------
// updateDmCodeGraph function
//-------------------------------------------------------

function updateDmCodeGraph( data ) {

  var div = d3.select("body").selectAll(".dmCodeDiv").data(data);
    // .data(data, function(d) { return d.damage_code; });

  div.text(function(d) { 
          var text = 'damage_code: ' + d.damage_code + ' : red = ' + 
                      d.darkred + ', blue = ' + d.darkblue + 
                      ', total = ' + d.total_counts + '.';
          return text; 
        });

  div.enter().append("div")
      .attr("class", "dmCodeDiv")
      .text(function(d) { 
          var text = 'damage_code: ' + d.damage_code + ' : red = ' + 
                      d.darkred + ', blue = ' + d.darkblue + 
                      ', total = ' + d.total_counts + '.';
          return text; 
        });
  div.exit().remove();


}
//-------------------------------------------------------

//-------------------------------------------------------
// updateGraph function
//-------------------------------------------------------

function updateGraph( msgs ) {

  // Get y_max for the yAxis
  y_max = 0.39; //minimum value
  msgs.forEach(function(msg){
    msg.data.forEach(function(d){
      y_max = Math.max(y_max, +d.counts);
    });
    y_max = Math.ceil(y_max * 10) / 10;
  }); // msgs.forEach(...)

  // UPDATE y scale
  y.domain([y_max, 0]);
  var ticks = d3.scale.linear().domain([0, 1]).ticks(11); //fancy way to make a range
  yAxis.scale(y).tickValues(ticks);
  svg.selectAll(".y.axis")
    .transition()
      .duration(750)
      .call(yAxis);

  // Update the bars
  msgs.forEach(function(msg){
    updateRects(msg.data, msg.color);
  }); // msgs.forEach(...)
}
//-------------------------------------------------------

//-------------------------------------------------------
// updateRects function
//-------------------------------------------------------

function updateRects( data, color ) {

  rectSelector = "." + color + ".rect";
  rectClassCreator = color + " rect";
  hShift = barDx(color);

  // DATA JOIN
  // join new data with old elements if any
  rects = svg.selectAll(rectSelector)
      .data(data, function(d, i){ return d.dfam; });
  // UPDATE
  // the bars
  rects
    .transition()
      .duration(750)
      .attr("fill", color)
      .attr("y", function(datum) { return y(datum.counts); })
      .attr("height", function(datum) { return y(0) - y(datum.counts); });
  // ENTER
  // the bars
  rects.enter().append("rect")
      .attr("class", rectClassCreator)
      .attr("x", function(d, index) { return x(d.dfam) + hShift; })
      .attr("y", y(0))
      .attr("height", 0)
      .attr("width", barWidth)
      .attr("fill", color)
    .transition()
      .duration(750)
      .attr("height", function(datum) { return y(0) - y(datum.counts); })
      .attr("y", function(datum) { return y(datum.counts); });
  // EXIT
  rects.exit().remove();

} // end update rects
//-------------------------------------------------------


//-------------------------------------------------------
// fillFilters function
//-------------------------------------------------------
// populate the filter lists with all available options from the database
//    uniqueColumns = ['brand','exam_year'];
function fillFilters(uniqueDict) {

  uniqueDict.exam_year
    .sort()
    .forEach( function(ey, index) {
      // list 1
      var ey1List = document.getElementById("ey1");
      var eyOption = new Option(ey, index);
      ey1List.options.add( eyOption );
      // list 2
      var ey2List = document.getElementById("ey2");
      var eyOption = new Option(ey, index);
      ey2List.options.add( eyOption );
    });

    uniqueDict.brand
    .sort()
    .forEach( function(brand, index) {
      // list 1
      var tb1List = document.getElementById("tb1");
      var tbOption = new Option(brand, index);
      tb1List.options.add( tbOption );
      // list 2
      var tb2List = document.getElementById("tb2");
      var tbOption = new Option(brand, index);
      tb2List.options.add( tbOption );
    });
}

</script>



